{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="display-5">
                <i class="bi bi-broadcast text-danger"></i>
                911 Call Generator
            </h1>
            <p class="lead text-muted">
                Generate realistic 911 emergency call audio for testing purposes
            </p>
        </div>

        <!-- Main Card -->
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <!-- Form -->
                <form id="generateForm">
                    <!-- Section: Script Source & Options -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-file-text"></i> Script Source
                        </h6>

                        <!-- Script Source Toggle -->
                        <div class="mb-3">
                        <label class="form-label fw-bold">
                            Source
                        </label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="scriptSource" id="scriptSourceCustom" value="custom" checked>
                            <label class="btn btn-outline-primary" for="scriptSourceCustom">
                                <i class="bi bi-magic"></i>
                                Generate with AI
                            </label>

                            <input type="radio" class="btn-check" name="scriptSource" id="scriptSourcePreloaded" value="preloaded">
                            <label class="btn btn-outline-primary" for="scriptSourcePreloaded">
                                <i class="bi bi-file-earmark-text"></i>
                                Use Pre-loaded Script
                            </label>
                        </div>
                        </div>

                        <!-- Diarization Option (Compact) -->
                        <div class="mb-3">
                        <div class="form-check form-check-inline">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                id="diarized"
                                name="diarized"
                            >
                            <label class="form-check-label small" for="diarized">
                                <strong>Diarized Audio</strong>
                                <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="right"
                                   title="Separate speakers on different stereo channels (dispatcher on left, caller on right)"></i>
                            </label>
                        </div>
                        </div>
                    </div>

                    <!-- Section: Call Configuration -->
                    <div id="callConfigurationSection">
                        <hr class="my-4">

                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-gear"></i> Call Configuration
                            </h6>
                            <div class="row mb-3">
                        <!-- Call Type Selection -->
                        <div class="col-md-6">
                            <label for="callType" class="form-label fw-bold">
                                Call Type
                            </label>
                            <select class="form-select" id="callType" name="call_type">
                                <option value="emergency" selected>Emergency Call</option>
                                <option value="transfer">Dispatcher Transfer</option>
                                <option value="warm_transfer">Warm Transfer to Nurse</option>
                                <option value="with_translator">Emergency Call with Translator</option>
                            </select>
                            <div class="form-text">
                                Type of 911 call
                            </div>
                        </div>

                        <!-- Call Duration Selection -->
                        <div class="col-md-6">
                            <label for="callDuration" class="form-label fw-bold">
                                Target Call Duration
                            </label>
                            <select class="form-select" id="callDuration" name="call_duration">
                                <option value="30">30 seconds</option>
                                <option value="60" selected>1 minute</option>
                                <option value="90">1.5 minutes</option>
                                <option value="120">2 minutes</option>
                                <option value="180">3 minutes</option>
                            </select>
                            <div class="form-text">
                                Target call length
                            </div>
                        </div>
                        </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Section: Language Settings -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-translate"></i> Language Settings
                        </h6>

                        <!-- Language Selection Row (Single Language) -->
                    <div class="row mb-3" id="singleLanguageSection">
                        <div class="col-md-12">
                            <label for="language" class="form-label fw-bold">
                                Language
                            </label>
                            <select class="form-select" id="language" name="language">
                                <option value="en" selected>English</option>
                                <option value="es">Spanish (Español)</option>
                                <option value="fr">French (Français)</option>
                                <option value="de">German (Deutsch)</option>
                                <option value="it">Italian (Italiano)</option>
                                <option value="pt">Portuguese (Português)</option>
                                <option value="pl">Polish (Polski)</option>
                                <option value="hi">Hindi (हिन्दी)</option>
                                <option value="ja">Japanese (日本語)</option>
                                <option value="ko">Korean (한국어)</option>
                                <option value="zh">Chinese (中文)</option>
                                <option value="ar">Arabic (العربية)</option>
                            </select>
                            <div class="form-text">
                                Dialogue language
                            </div>
                        </div>
                    </div>

                    <!-- Language Selection Row (Multi-Language for Translator) -->
                    <div class="row mb-3" id="multiLanguageSection" style="display: none;">
                        <div class="col-md-12 mb-2">
                            <label class="form-label fw-bold">
                                <i class="bi bi-translate"></i>
                                Languages
                            </label>
                            <div class="form-text text-primary">
                                <i class="bi bi-info-circle"></i> Select the language for each participant
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="dispatcherLanguage" class="form-label fw-bold">
                                Dispatcher Language
                            </label>
                            <select class="form-select" id="dispatcherLanguage" name="dispatcher_language">
                                <option value="en" selected>English</option>
                                <option value="es">Spanish (Español)</option>
                                <option value="fr">French (Français)</option>
                                <option value="de">German (Deutsch)</option>
                                <option value="it">Italian (Italiano)</option>
                                <option value="pt">Portuguese (Português)</option>
                                <option value="pl">Polish (Polski)</option>
                                <option value="hi">Hindi (हिन्दी)</option>
                                <option value="ja">Japanese (日本語)</option>
                                <option value="ko">Korean (한국어)</option>
                                <option value="zh">Chinese (中文)</option>
                                <option value="ar">Arabic (العربية)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="callerLanguage" class="form-label fw-bold">
                                Caller Language
                            </label>
                            <select class="form-select" id="callerLanguage" name="caller_language">
                                <option value="en">English</option>
                                <option value="es" selected>Spanish (Español)</option>
                                <option value="fr">French (Français)</option>
                                <option value="de">German (Deutsch)</option>
                                <option value="it">Italian (Italiano)</option>
                                <option value="pt">Portuguese (Português)</option>
                                <option value="pl">Polish (Polski)</option>
                                <option value="hi">Hindi (हिन्दी)</option>
                                <option value="ja">Japanese (日本語)</option>
                                <option value="ko">Korean (한국어)</option>
                                <option value="zh">Chinese (中文)</option>
                                <option value="ar">Arabic (العربية)</option>
                            </select>
                        </div>
                    </div>
                    </div>

                    <hr class="my-4">

                    <!-- Section: Scenario Details -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-pencil-square"></i> Scenario Details
                        </h6>

                        <!-- Pre-loaded Script Selector (Hidden by default) -->
                        <div class="mb-4" id="preloadedScriptSection" style="display: none;">
                        <label for="scriptSelector" class="form-label fw-bold">
                            Select Script
                        </label>
                        <select class="form-select" id="scriptSelector" name="script_filename">
                            <option value="">Loading scripts...</option>
                        </select>
                        <div class="form-text">
                            Choose from pre-made 911 call scenarios
                        </div>
                    </div>

                    <!-- Prompt Input -->
                    <div class="mb-4" id="customPromptSection">
                        <label for="prompt" class="form-label fw-bold">
                            <i class="bi bi-pencil-square"></i>
                            <span id="promptLabel">Emergency Scenario Description</span>
                        </label>
                        <textarea
                            class="form-control"
                            id="prompt"
                            name="prompt"
                            rows="4"
                            maxlength="500"
                            placeholder="Describe the emergency scenario... (e.g., 'Car accident on Highway 101 with multiple injuries')"
                        ></textarea>
                        <div class="form-text">
                            <span id="charCount">0</span>/500 characters
                        </div>
                    </div>

                    <!-- Protocol Questions Toggle (Optional) -->
                    <div class="mb-4" id="protocolQuestionsToggle">
                        <button
                            class="btn btn-outline-secondary btn-sm"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#protocolQuestionsSection"
                            aria-expanded="false"
                            aria-controls="protocolQuestionsSection"
                            id="toggleProtocolBtn">
                            <i class="bi bi-plus-circle"></i>
                            Add Protocol Questions (Optional)
                        </button>

                        <div class="collapse mt-3" id="protocolQuestionsSection">
                            <!-- Dispatcher Protocol Questions -->
                            <div id="dispatcherProtocolSection">
                                <label for="dispatcherProtocolQuestions" class="form-label fw-bold">
                                    <span id="dispatcherProtocolLabel">Protocol Questions</span>
                                </label>
                                <textarea
                                    class="form-control"
                                    id="dispatcherProtocolQuestions"
                                    name="dispatcher_protocol_questions"
                                    rows="3"
                                    maxlength="500"
                                    placeholder="Enter specific questions the dispatcher should ask (one per line)&#10;Example:&#10;- What is the exact address?&#10;- Are there any weapons involved?&#10;- Is anyone injured?"
                                ></textarea>
                                <div class="form-text" id="dispatcherProtocolHelp">
                                    Specific questions the dispatcher must ask during the call
                                </div>
                            </div>

                            <!-- Nurse Protocol Questions (Warm Transfer Only) -->
                            <div id="nurseProtocolSection" class="mt-3" style="display: none;">
                                <label for="nurseProtocolQuestions" class="form-label fw-bold">
                                    Nurse Protocol Questions
                                </label>
                                <textarea
                                    class="form-control"
                                    id="nurseProtocolQuestions"
                                    name="nurse_protocol_questions"
                                    rows="3"
                                    maxlength="500"
                                    placeholder="Enter specific questions the nurse should ask (one per line)&#10;Example:&#10;- What medications are you currently taking?&#10;- Do you have any allergies?&#10;- On a scale of 1-10, how severe is the pain?"
                                ></textarea>
                                <div class="form-text">
                                    Specific questions the nurse must ask during the medical assessment
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <hr class="my-4">

                    <!-- Section: Voice Selection -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-mic"></i> Voice Selection
                        </h6>

                        <!-- Voice Selection (Side by Side) -->
                    <div class="row mb-3">
                        <!-- First Speaker Voice Selection -->
                        <div class="col-md-6">
                            <label for="dispatcherVoice" class="form-label fw-bold">
                                <span id="voice1Label">Dispatcher Voice</span>
                            </label>
                            <div class="input-group">
                                <select class="form-select" id="dispatcherVoice" name="dispatcher_voice_id" required>
                                    <option value="">Loading voices...</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" id="previewDispatcher" disabled>
                                    <i class="bi bi-volume-up"></i>
                                </button>
                            </div>
                            <div class="form-text" id="voice1Help">
                                Professional, calm voice
                            </div>
                        </div>

                        <!-- Second Speaker Voice Selection -->
                        <div class="col-md-6">
                            <label for="callerVoice" class="form-label fw-bold">
                                <span id="voice2Label">Caller Voice</span>
                            </label>
                            <div class="input-group">
                                <select class="form-select" id="callerVoice" name="caller_voice_id" required>
                                    <option value="">Loading voices...</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" id="previewCaller" disabled>
                                    <i class="bi bi-volume-up"></i>
                                </button>
                            </div>
                            <div class="form-text" id="voice2Help">
                                Emotional, varied voice
                            </div>
                        </div>
                    </div>

                    <!-- Third Speaker Voice Selection (Warm Transfer Only) -->
                    <div class="mb-3" id="nurseVoiceSection" style="display: none;">
                        <label for="nurseVoice" class="form-label fw-bold">
                            <span id="voice3Label">Nurse Voice</span>
                        </label>
                        <div class="input-group">
                            <select class="form-select" id="nurseVoice" name="nurse_voice_id">
                                <option value="">Loading voices...</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" id="previewNurse" disabled>
                                <i class="bi bi-volume-up"></i> Preview
                            </button>
                        </div>
                        <div class="form-text" id="voice3Help">
                            Calm, professional voice for the nurse
                        </div>
                    </div>
                    </div>

                    <hr class="my-4">

                    <!-- Section: Caller Behavior -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-person"></i> Caller Behavior
                        </h6>

                        <!-- Caller Emotion & Erratic Behavior (Side by Side) -->
                    <div class="row mb-3">
                        <!-- Caller Emotion Level (Emergency Calls Only) -->
                        <div class="col-md-6" id="emotionLevelSection">
                            <label for="emotionLevel" class="form-label fw-bold">
                                Caller Emotion Level
                            </label>
                            <select class="form-select" id="emotionLevel" name="emotion_level">
                                <option value="calm">Calm - Composed and clear</option>
                                <option value="concerned" selected>Concerned - Worried but coherent</option>
                                <option value="anxious">Anxious - Nervous and stressed</option>
                                <option value="panicked">Panicked - Very distressed</option>
                                <option value="hysterical">Hysterical - Extremely emotional</option>
                            </select>
                            <div class="form-text">
                                How emotional/distressed the caller sounds
                            </div>
                        </div>

                        <!-- Caller Erratic Behavior Level (Emergency & Warm Transfer Calls Only) -->
                        <div class="col-md-6" id="erraticLevelSection">
                            <label for="erraticLevel" class="form-label fw-bold">
                                Caller Erratic Behavior Level
                            </label>
                            <select class="form-select" id="erraticLevel" name="erratic_level">
                                <option value="none" selected>None - Focused and coherent</option>
                                <option value="slight">Slight - Minor rambling or tangents</option>
                                <option value="moderate">Moderate - Some difficulty staying on topic</option>
                                <option value="high">High - Frequent interruptions and tangents</option>
                                <option value="extreme">Extreme - Very difficult to manage, highly incoherent</option>
                            </select>
                            <div class="form-text">
                                How erratic/difficult the caller is (rambling, interrupting, going off-topic)
                            </div>
                        </div>
                    </div>
                    </div>

                    <hr class="my-4">

                    <!-- Section: Audio Settings -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-soundwave"></i> Audio Settings
                        </h6>

                        <!-- Audio Format & Quality (Side by Side) -->
                    <div class="row mb-3">
                        <!-- Audio Format Selection -->
                        <div class="col-md-6">
                            <label for="audioFormat" class="form-label fw-bold">
                                Audio Format
                            </label>
                            <select class="form-select" id="audioFormat" name="audio_format">
                                <option value="mp3" selected>MP3 (Compressed)</option>
                                <option value="wav">WAV (Uncompressed)</option>
                            </select>
                            <div class="form-text">
                                File format for export
                            </div>
                        </div>

                        <!-- Audio Quality Selection -->
                        <div class="col-md-6">
                            <label for="audioQuality" class="form-label fw-bold">
                                Audio Quality
                            </label>
                            <select class="form-select" id="audioQuality" name="audio_quality">
                                <option value="high">High - Best quality</option>
                                <option value="medium">Medium - Standard</option>
                                <option value="low" selected>Low - Phone quality</option>
                                <option value="very_low">Very Low - Poor connection</option>
                            </select>
                            <div class="form-text">
                                Simulates connection quality
                            </div>
                        </div>
                    </div>

                    <!-- Background Noise Type & Level (Side by Side) -->
                    <div class="row mb-3">
                        <!-- Background Noise Type Selection -->
                        <div class="col-md-6">
                            <label for="backgroundNoiseType" class="form-label fw-bold">
                                Background Noise Type
                            </label>
                            <select class="form-select" id="backgroundNoiseType" name="background_noise_type">
                                <option value="none" selected>None - Clean audio</option>
                                <option value="static">Phone Static</option>
                                <option value="dispatch">Dispatch Center</option>
                                <option value="traffic">Traffic/Road</option>
                                <option value="sirens">Emergency Sirens</option>
                                <option value="crowd">Crowd/Public</option>
                                <option value="wind">Wind/Outdoor</option>
                            </select>
                            <div class="form-text">
                                Type of ambient noise
                            </div>
                        </div>

                        <!-- Background Noise Level Selection -->
                        <div class="col-md-6" id="noiseLevelSection" style="display: none;">
                            <label for="backgroundNoiseLevel" class="form-label fw-bold">
                                Background Noise Level
                            </label>
                            <select class="form-select" id="backgroundNoiseLevel" name="background_noise_level">
                                <option value="light">Light - Subtle</option>
                                <option value="moderate" selected>Moderate - Noticeable</option>
                                <option value="heavy">Heavy - Significant</option>
                                <option value="extreme">Extreme - Very loud</option>
                            </select>
                            <div class="form-text">
                                Volume level
                            </div>
                        </div>
                    </div>
                    </div>

                    <hr class="my-4">

                    <!-- Generate Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                            <i class="bi bi-play-circle"></i>
                            Generate Call
                        </button>
                    </div>
                </form>

                <!-- Loading Section -->
                <div id="loadingSection" class="mt-4 d-none">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mb-0" id="loadingMessage">Generating dialogue...</p>
                        </div>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="errorSection" class="mt-4 d-none">
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <span id="errorMessage"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="mt-4 d-none">
                    <hr>
                    <h5 class="mb-3">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        Generated Call
                    </h5>

                    <!-- Audio Player -->
                    <div class="mb-3">
                        <audio id="audioPlayer" controls class="w-100"></audio>
                    </div>

                    <!-- Call Details -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <div class="text-muted small">Duration</div>
                                    <div class="fw-bold" id="callDurationDisplay">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <div class="text-muted small">Exchanges</div>
                                    <div class="fw-bold" id="callExchanges">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <div class="text-muted small">Format</div>
                                    <div class="fw-bold" id="callFormat">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Download Button -->
                    <div class="d-grid">
                        <a id="downloadBtn" href="#" class="btn btn-success" download>
                            <i class="bi bi-download"></i>
                            Download Audio File
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="card mt-4 d-none">
            <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#historyCollapse" aria-expanded="false">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history"></i>
                    Recent Prompts
                    <i class="bi bi-chevron-down ms-2" id="historyChevron"></i>
                </h6>
                <button type="button" class="btn btn-sm btn-outline-danger" id="clearHistory" onclick="event.stopPropagation()">
                    <i class="bi bi-trash"></i> Clear
                </button>
            </div>
            <div class="collapse" id="historyCollapse">
                <div class="card-body">
                    <div id="historyList">
                        <!-- History items will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- How It Works Modal -->
<div class="modal fade" id="howItWorksModal" tabindex="-1" aria-labelledby="howItWorksModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="howItWorksModalLabel">
                    <i class="bi bi-info-circle text-info"></i>
                    How it works
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="mb-0">
                    <li class="mb-2">Enter a description of an emergency scenario</li>
                    <li class="mb-2">AI generates realistic dialogue between a 911 dispatcher and caller</li>
                    <li class="mb-2">Text-to-speech creates natural-sounding audio</li>
                    <li class="mb-0">Download the audio for testing or training purposes</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
